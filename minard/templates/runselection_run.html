{% macro collapsible_header(title,name,run_data,criteria_data) %}
<div class="row">
  <div class="col-md-12">
    <div class="panel-group">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 id="title-{{name}}" class="panel-title">
            <a data-toggle="collapse" href="#collapse{{title}}">
              <b>{{title}}</b>
            </a>
          </h4>
        </div>
        <div id="collapse{{title}}" class="panel-collapse collapse out">
          <div class='panel-body' id='{{name}}'>
            {{ caller() }}
            {% for key in run_data[title]["decision"]["rs_modules"] %}
              {% if key != "dqll" %}
                <div class="row">
                  <div class="col-md-12">
                    <div class="panel panel-default" style="margin-bottom: 20px">
                      <div class="panel-heading">
                        <h1 class="panel-title"><b>{{ key }}</b></h1>
                      </div>
                      <div class="panel-body">
                        <div class="row">
                          <div class="col-md-12">
                            <table class="table">
                              <thead>
                                <tr>
                                  <th width=25.0%>Check</th>
                                  <th width=25.0%>Threshold</th>
                                  <th width=25.0%>Value</th>
                                  <th width=25.0%>Result</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% if "error" in run_data[title][key].keys() %}
                                  <tr class="bg-danger" >
                                    <td colspan="12" style="text-align:center;">
                                      <b> No data for {{ key }}! </b>
                                    </td>
                                  </tr>
                                {% else %}
                                  {% for subkey in run_data[title][key]["results"] %}
                                    {% if subkey != "and_result" %}
                                      {% set subkeyResult = [] %}
                                      {% if run_data[title][key]["results"][subkey] is mapping %}
                                        {% for subsubkey in run_data[title][key]["results"][subkey].keys() %}
                                          {% if run_data[title][key]["results"][subkey][subsubkey] == false %}
                                            {% if subkeyResult.append(1) %}
                                            {% endif %}
                                          {% endif %}
                                        {% endfor %}
                                      {% else %}
                                        {% if run_data[title][key]["results"][subkey] == false %}
                                          {% if subkeyResult.append(1) %}
                                          {% endif %}
                                        {% endif %}
                                      {% endif %}
                                      {% if subkeyResult %}
                                        <tr class="bg-danger" >
                                          <td>{{ subkey }}</td>

                                          {% if subkey == "alarms" %}
                                            <td>
                                              {% for subsubkey in criteria_data[title][key][subkey].keys() %}
                                                {% if loop.first %}
                                                  <li> {{ subsubkey }} </li>
                                                {% else %}
                                                  <li>{{ subsubkey }}</li>
                                                {% endif %}
                                              {% endfor %}
                                            </td>
                                          {% elif key == "channel_flags" %}
                                            <td>
                                              {% for subsubkey in criteria_data[title][key] %}
                                                <li>{{ subsubkey }} : {{ criteria_data[title][key][subsubkey] }} </li>
                                              {% endfor %}
                                            </td>
                                          {% elif key == "dqhl" %}
                                            <td>
                                              {% for subsubkey in criteria_data[title][key] %}
                                                {% if subsubkey in run_data[title][key]["notes"][subkey] %}
                                                  <li>{{ subsubkey }} : {{ criteria_data[title][key][subsubkey] }} </li>
                                                {% endif %}
                                              {% endfor %}
                                            </td>
                                          {% elif criteria_data[title][key][subkey] is iterable and (criteria_data[title][key][subkey] is not string and criteria_data[title][key][subkey] is not mapping) %}
                                            <td>
                                              {% for subsubkey in criteria_data[title][key][subkey] %}
                                                <li>{{ subsubkey }} </li>
                                              {% endfor %}
                                            </td>
                                          {% else %}
                                            <td>{{ criteria_data[title][key][subkey] }}</td>
                                          {% endif %}

                                          {% if "notes" in run_data[title][key].keys()%}
                                            {% if subkey in run_data[title][key]["notes"].keys()%}
                                              {% if run_data[title][key]["notes"][subkey] is mapping %}
                                                {% if subkey in run_data[title][key]["notes"][subkey].keys() %}
                                                  {% for subsubkey in run_data[title][key]["notes"][subkey] %}
                                                    {% if subsubkey == subkey %}
                                                      <td>{{ run_data[title][key]["notes"][subkey][subsubkey] }}</td>
                                                    {% endif %}
                                                  {% endfor %}
                                                {% else %}
                                                  <td>
                                                  {% for subsubkey in run_data[title][key]["notes"][subkey] %}
                                                    {% if loop.first %}
                                                      {% if subkey == "alarms" %}
                                                        <li>{{ run_data[title][key]["notes"][subkey][subsubkey]["description"] }}</li>
                                                      {% else %}
                                                        <li>{{ subsubkey }} : {{ run_data[title][key]["notes"][subkey][subsubkey] }}</li>
                                                      {% endif %}
                                                    {% else %}
                                                      {% if subkey == "alarms" %}
                                                        <li>{{ run_data[title][key]["notes"][subkey][subsubkey]["description"] }}</li>
                                                      {% else %}
                                                        <li>{{ subsubkey }} : {{ run_data[title][key]["notes"][subkey][subsubkey] }}</li>
                                                      {% endif %}
                                                    {% endif %}
                                                  {% endfor %}
                                                  </td>
                                                {% endif %}
                                              {% else %}
                                                {% if run_data[title][key]["notes"][subkey] is iterable and (run_data[title][key]["notes"][subkey] is not string and run_data[title][key]["notes"][subkey] is not mapping) %}
                                                  <td>{{ run_data[title][key]["notes"][subkey][0] }}</td>
                                                {% else %}
                                                  <td>{{ run_data[title][key]["notes"][subkey] }}</td>
                                                {% endif %}
                                              {% endif %}
                                            {% else %}
                                              <td>0 / True</td>
                                            {% endif %}
                                          {% else %}
                                            <td>0</td>
                                          {% endif %}

                                          {% if run_data[title][key]["results"][subkey] is mapping %}
                                            <td>
                                            {% for subsubkey in run_data[title][key]["results"][subkey].keys() %}
                                              {% if loop.first %}
                                                {{ subsubkey }} : {{ run_data[title][key]["results"][subkey][subsubkey] }}
                                              {% else %}
                                                <br> {{ subsubkey }} : {{ run_data[title][key]["results"][subkey][subsubkey] }}
                                              {% endif %}
                                            {% endfor %}
                                            </td>
                                          {% else %}
                                            <td>{{ run_data[title][key]["results"][subkey] }}</td>
                                          {% endif %}
                                        </tr>
                                      {% else %}
                                        <tr class="bg-success">
                                          <td>{{ subkey }}</td>
                                          {% if subkey == "alarms" %}
                                            <td>
                                              <ul>
                                                {% for subsubkey in criteria_data[title][key][subkey].keys() %}
                                                  {% if loop.first %}
                                                    <li> {{ subsubkey }} </li>
                                                  {% else %}
                                                    <li>{{ subsubkey }}</li>
                                                  {% endif %}
                                                {% endfor %}
                                              </ul>
                                            </td>
                                          {% elif key == "channel_flags" %}
                                            <td>
                                              {% for subsubkey in criteria_data[title][key] %}
                                                <li>{{ subsubkey }} : {{ criteria_data[title][key][subsubkey] }} </li>
                                              {% endfor %}
                                            </td>
                                          {% elif key == "dqhl" %}
                                            <td>
                                              {% for subsubkey in criteria_data[title][key] %}
                                                {% if subsubkey in run_data[title][key]["notes"][subkey] %}
                                                  <li>{{ subsubkey }} : {{ criteria_data[title][key][subsubkey] }} </li>
                                                {% endif %}
                                              {% endfor %}
                                            </td>
                                          {% elif criteria_data[title][key][subkey] is iterable and (criteria_data[title][key][subkey] is not string and criteria_data[title][key][subkey] is not mapping) %}
                                            <td>
                                              {% for subsubkey in criteria_data[title][key][subkey] %}
                                                <li>{{ subsubkey }} </li>
                                              {% endfor %}
                                            </td>
                                          {% else %}
                                            <td>{{ criteria_data[title][key][subkey] }}</td>
                                          {% endif %}
                                          {% if "notes" in run_data[title][key].keys()%}
                                            {% if subkey in run_data[title][key]["notes"].keys()%}
                                              {% if run_data[title][key]["notes"][subkey] is mapping %}
                                                {% if subkey in run_data[title][key]["notes"][subkey].keys() %}
                                                  {% for subsubkey in run_data[title][key]["notes"][subkey] %}
                                                    {% if subsubkey == subkey %}
                                                      <td>{{ run_data[title][key]["notes"][subkey][subsubkey] }}</td>
                                                    {% endif %}
                                                  {% endfor %}
                                                {% else %}
                                                  <td>
                                                  {% for subsubkey in run_data[title][key]["notes"][subkey] %}
                                                    {% if loop.first %}
                                                      {% if subkey == "alarms" %}
                                                        <li>{{ run_data[title][key]["notes"][subkey][subsubkey]["description"] }}</li>
                                                      {% else %}
                                                        <li>{{ subsubkey }} : {{ run_data[title][key]["notes"][subkey][subsubkey] }}</li>
                                                      {% endif %}
                                                    {% else %}
                                                      {% if subkey == "alarms" %}
                                                        <li>{{ run_data[title][key]["notes"][subkey][subsubkey]["description"] }}</li>
                                                      {% else %}
                                                        <li>{{ subsubkey }} : {{ run_data[title][key]["notes"][subkey][subsubkey] }}</li>
                                                      {% endif %}
                                                    {% endif %}
                                                  {% endfor %}
                                                  </td>
                                                {% endif %}
                                              {% else %}
                                                {% if run_data[title][key]["notes"][subkey] is iterable and (run_data[title][key]["notes"][subkey] is not string and run_data[title][key]["notes"][subkey] is not mapping) %}
                                                  <td>{{ run_data[title][key]["notes"][subkey][0] }}</td>
                                                {% else %}
                                                  <td>{{ run_data[title][key]["notes"][subkey] }}</td>
                                                {% endif %}
                                              {% endif %}
                                            {% else %}
                                              <td>0 / True</td>
                                            {% endif %}
                                          {% else %}
                                            <td>0</td>
                                          {% endif %}

                                          {% if run_data[title][key]["results"][subkey] is mapping %}
                                            <td>
                                            {% for subsubkey in run_data[title][key]["results"][subkey] %}
                                              {% if loop.first %}
                                                {{ subsubkey }} : {{ run_data[title][key]["results"][subkey][subsubkey] }}
                                              {% else %}
                                                <br> {{ subsubkey }} : {{ run_data[title][key]["results"][subkey][subsubkey] }}
                                              {% endif %}
                                            {% endfor %}
                                            </td>
                                          {% else %}
                                            <td>{{ run_data[title][key]["results"][subkey] }}</td>
                                          {% endif %}
                                        </tr>
                                      {% endif %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endmacro %}
{% extends "layout.html" %}
{% block title %}Run Selection Run Detail{% endblock %}
{% block head %}
  {{ super() }}
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/pca.css') }}" media="screen">
{% endblock %}
{% block body %}
  {{ super() }}

  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1 style="text-align:center">Run selection for run {{ run_number }}</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h1 class="panel-title"><b>General information</b></h1>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-md-12">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th width="50.0%">Parameter</th>
                      <th width="50.0%">Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Run</td>
                      <td>{{ run_info[run_number]["scintillator"]["run_range"][0] }}</td>
                    </tr>
                    <tr>
                      <td>Start timestamp</td>
                      <td>{{ run_info[run_number]["scintillator"]["run_time"]["notes"]["dt"]["timestamp"] }}</td>
                    </tr>
                    <tr>
                      <td>Duration</td>
                      <td>{{ run_info[run_number]["scintillator"]["run_time"]["notes"]["dt"]["orca_duration"] }} s</td>
                    </tr>
                    <tr>
                      <td>Criteria</td>
                      <td>
                        {% for criteria in run_info[run_number].keys() %}
                        {% if loop.last %}
                          {{criteria}}
                        {% else %}
                          {{criteria}},
                        {% endif %}
                        {% endfor %} 
                      </td>
                    </tr>
                    {% for index in run_info[run_number].keys() %}
                    <tr>
                      <td>{{ index }} result</td>
                      {% if run_info[run_number][index]["decision"]["result"] == true %}
                      <td><font color="green">Pass</font></td>
                      {% elif run_info[run_number][index]["decision"]["result"] == none %}
                      <td>Purgatory</td>
                      {% else %}
                      <td><font color="red">Fail</font></td>
                      {% endif %}
                    </tr>
                    {% endfor %}
                    <tr>
                      <td>Last reviewed</td>
                      <td>{{ run_info[run_number]["scintillator"]["time"] }}</td>
                    </tr>
                    <tr>
                      <td>Last reviewer</td>
                      <td>{{ run_info[run_number]["scintillator"]["name"] }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <h1 style="text-align:left">Run selection results</h1>
      </div>
    </div>

    {% for index in run_info[run_number].keys() %}
    {% if index %}
        {% call collapsible_header(index,'index',run_info[run_number],criteria_info) %}
        {% endcall %}
    {% endif %}
    {% endfor %} 

    <div class="row">
      <div class="col-md-12">
        <h1 style="text-align:left">Run list history</h1>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <table class="table table-striped">
          <thead>
            <tr>
              <th width="20.0%">Date</th>
              <th width="20.0%">List added</th>
              <th width="20.0%">List removed</th>
              <th width="20.0%">Comment</th>
              <th width="20.0%">Name</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <h1 style="text-align:left">Run list control</h1>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <form action="{{ url_for('runselection_run_number', run_number=run_number)}}" method="POST" role="form">
          {% macro form_checkbox(field) -%}
              <div class="checkbox">
                  <label class="active"><input type="checkbox" name="{{ field.name }}" {% if field.data %}checked="checked"{% endif %}>{{ field.label.text }}</input></label>
              </div>
          {%- endmacro %}
          <div class="alert alert-info">
              <p>Note: When you press Submit, the run lists will be updated. Please ensure the boxes checked are the correct lists for this run!
          </div>
          <div class="col-md-6">
            {% for i in range((lists|length/2)|round|int) %}
            <tr>
              {{ form_checkbox(form[lists[i]]) }}
            </tr>
            {% endfor %}
          </div>
          <div class="col-md-6">
            {% for i in range((lists|length/2)|round|int, lists|length) %}
            <tr>
              {{ form_checkbox(form[lists[i]]) }}
            </tr>
            {% endfor %}
          </div>
          <div>
            {% if form.name.errors %}
              <div class="form-group has-error">
            {% else %}
              <div class="form-group">
            {% endif %}
            <label for="name">{{ form.name.label }}</label>
            <input type="text" class="form-control" name="{{ form.name.name }}" placeholder="Dr P. L. Ace Holder" {% if form.name.data %}value="{{ form.name.data }}"{% endif %}></input>
            {% if form.name.errors %}
              {% for error in form.name.errors %}
                  <span class="help-block">{{ error }}</span>
              {% endfor %}
            {% endif %}
          </div>
          <div>
            {% if form.comment.errors %}
              <div class="form-group has-error">
            {% else %}
              <div class="form-group">
            {% endif %}
            <label for="comment">{{ form.comment.label }}</label>
            <input type="text" class="form-control" name="{{ form.comment.name }}" placeholder="Comment" {% if form.comment.data %}value="{{ form.comment.data }}"{% endif %}></input>
            {% if form.comment.errors %}
              {% for error in form.comment.errors %}
                  <span class="help-block">{{ error }}</span>
              {% endfor %}
            {% endif %}
          </div>
          {% if form.password.errors %}
            <div class="form-group has-error">
          {% else %}
            <div class="form-group">
          {% endif %}
          <label for="info">{{ form.password.label }}</label>
          <input type="password" class="form-control" name="{{ form.password.name }}" placeholder="Password"></input>
          {% if form.password.errors %}
              {% for error in form.password.errors %}
                  <span class="help-block">{{ error }}</span>
              {% endfor %}
          {% endif %}
          </div>
          <button type="submit" class="btn btn-success">Submit</button>
          </form>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
      </div>
    </div>
  {% endblock %}

{% block script %}
  <script src="{{ url_for('static', filename='js/burst_form.js') }}"></script>
{% endblock %}
